<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skyline Ace: Precise Controls</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap');
        :root { --accent: #00f2ff; --danger: #ff4444; --ally: #00ff88; --glass: rgba(0, 0, 0, 0.7); }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Quicksand', sans-serif; touch-action: none; color: white; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, rgba(10,30,70,0.95), #000);
            z-index: 2000; transition: opacity 0.8s;
        }
        .card {
            background: var(--glass); backdrop-filter: blur(25px);
            padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; width: 80%; max-width: 380px;
        }
        h1 { font-weight: 300; letter-spacing: 6px; margin: 0 0 15px; font-size: 1.8rem; }
        .opt-btn {
            flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 8px; cursor: pointer; font-size: 11px;
        }
        .opt-btn.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 700; }
        .start-btn {
            width: 100%; margin-top: 20px; padding: 15px; border-radius: 50px;
            background: #fff; color: #000; border: none; font-weight: 700; cursor: pointer;
        }

        /* HUD & Controls Container */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; display: none; }
        .hud-el { position: absolute; padding: 8px 12px; background: var(--glass); border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hud-tl { top: 15px; left: 15px; border-left: 3px solid var(--accent); }
        .hud-tr { top: 15px; right: 15px; text-align: right; border-right: 3px solid var(--danger); }
        .hud-tm { top: 15px; left: 50%; transform: translateX(-50%); text-align: center; width: 100px; }
        
        /* Central Radar - Positioned higher to avoid joysticks */
        #radar-ui {
            position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%);
            width: 90px; height: 90px; border-radius: 50%; border: 1px solid rgba(0,242,255,0.2);
            background: radial-gradient(circle, rgba(0,30,30,0.6) 0%, rgba(0,10,10,0.8) 100%);
            backdrop-filter: blur(4px); pointer-events: none;
        }
        .radar-dot { position: absolute; width: 3px; height: 3px; border-radius: 50%; transform: translate(-50%, -50%); }
        #radar-player { position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: white; border-radius: 50%; transform: translate(-50%, -50%); }

        /* Left Control: Small Joystick */
        #joystick-zone { 
            position: absolute; bottom: 20px; left: 20px; width: 100px; height: 100px; 
            pointer-events: auto; z-index: 1000; touch-action: none;
        }

        /* Right Controls: Lever & Fire */
        #speed-lever-zone {
            position: absolute; right: 20px; bottom: 120px;
            height: 100px; width: 60px; pointer-events: auto; display: flex; flex-direction: column; align-items: center;
            z-index: 1000;
        }
        #speed-slider { 
            -webkit-appearance: none; width: 80px; height: 4px; background: rgba(255,255,255,0.2); 
            transform: rotate(-90deg); margin-top: 40px; outline: none; 
        }
        #speed-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 30px; height: 18px; background: var(--accent); 
            cursor: pointer; border-radius: 3px; box-shadow: 0 0 8px var(--accent); 
        }
        
        #fire-btn { 
            position: absolute; bottom: 20px; right: 20px; width: 75px; height: 75px; 
            border-radius: 50%; background: rgba(255,50,50,0.3); border: 2px solid var(--danger);
            display: flex; justify-content: center; align-items: center; pointer-events: auto; 
            color: white; font-weight: 700; z-index: 1000; font-size: 14px;
        }

        #msg-box { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); font-size: 18px; color: var(--accent); text-align: center; pointer-events: none; width: 100%; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <div class="card">
            <h1>SKYLINE ACE</h1>
            <div style="text-align:left; margin-bottom:15px;">
                <div style="font-size:9px; opacity:0.6; letter-spacing:2px; margin-bottom:5px;">UNIT</div>
                <div style="display:flex; gap:10px;" id="unit-select">
                    <button class="opt-btn active" data-val="JET">JET</button>
                    <button class="opt-btn" data-val="UFO">UFO</button>
                </div>
            </div>
            <div style="text-align:left; margin-bottom:15px;">
                <div style="font-size:9px; opacity:0.6; letter-spacing:2px; margin-bottom:5px;">ACE LEVEL</div>
                <div style="display:flex; gap:5px;" id="diff-select">
                    <button class="opt-btn active" data-val="1">1</button>
                    <button class="opt-btn" data-val="2">2</button>
                    <button class="opt-btn" data-val="3">3</button>
                    <button class="opt-btn" data-val="4">4</button>
                    <button class="opt-btn" data-val="5">5</button>
                </div>
            </div>
            <button id="start-btn" class="start-btn">INITIATE</button>
        </div>
    </div>

    <div id="over-screen" class="screen" style="display:none;">
        <div class="card">
            <h1 id="over-title" style="font-size:1.5rem;">MISSION END</h1>
            <div id="over-stats" style="margin:15px 0; font-size:14px; opacity:0.8;"></div>
            <button onclick="location.reload()" class="start-btn">REDEPLOY</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="hud-el hud-tl">
            <div style="font-size:8px; opacity:0.7;">ALT / SPD</div>
            <div style="font-size:16px;"><span id="alt-val">0</span> / <span id="spd-val">0</span></div>
        </div>
        <div class="hud-el hud-tr">
            <div style="font-size:8px; opacity:0.7;">KILLS / GOAL</div>
            <div style="font-size:16px;"><span id="kill-val">0</span> / <span id="target-val">0</span></div>
        </div>
        <div class="hud-el hud-tm">
            <div style="font-size:8px; opacity:0.7;">REMAINING</div>
            <div style="font-size:16px; color:var(--danger);" id="timer-val">60</div>
        </div>
        
        <div id="radar-ui"><div id="radar-player"></div><div id="radar-dots"></div></div>
        
        <div id="speed-lever-zone">
            <div style="font-size:8px; opacity:0.6; margin-bottom:30px;">THRUST</div>
            <input type="range" id="speed-slider" min="0" max="100" value="0">
        </div>
        <div id="joystick-zone"></div>
        <div id="fire-btn">FIRE</div>
        <div id="msg-box"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        const SOUNDS = {
            engine: 'https://actions.google.com/sounds/v1/transportation/jet_plane_flying_loop.ogg',
            laser: 'https://actions.google.com/sounds/v1/science_fiction/low_laser_shot.ogg',
            explosion: 'https://actions.google.com/sounds/v1/explosions/distant_explosion.ogg'
        };

        class Game {
            constructor() {
                this.state = { active: false, takeoff: false, paused: false, unit: 'JET', difficulty: 1, kills: 0, targetKills: 10, timeLeft: 60 };
                this.input = { joystick: {x:0, y:0}, thrust: 0, firing: false };
                this.entities = { player: null, allies: [], enemies: [], bullets: [], ships: [], airliners: [], particles: [], landmarks: [] };
                this.audio = {};
                this.initScene();
                this.setupUI();
                this.clock = new THREE.Clock();
                this.animate();
            }

            initScene() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 80000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                document.body.appendChild(this.renderer.domElement);
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth/window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            initAudio() {
                const listener = new THREE.AudioListener();
                this.camera.add(listener);
                const loader = new THREE.AudioLoader();
                this.audio.engine = new THREE.Audio(listener);
                loader.load(SOUNDS.engine, buf => { this.audio.engine.setBuffer(buf); this.audio.engine.setLoop(true); this.audio.engine.setVolume(0.2); });
                this.audio.laser = new THREE.Audio(listener);
                loader.load(SOUNDS.laser, buf => { this.audio.laser.setBuffer(buf); this.audio.laser.setVolume(0.3); });
                this.audio.explosion = new THREE.Audio(listener);
                loader.load(SOUNDS.explosion, buf => { this.audio.explosion.setBuffer(buf); this.audio.explosion.setVolume(0.5); });
            }

            initWorld() {
                const isDay = new Date().getHours() > 6 && new Date().getHours() < 19;
                this.scene.background = new THREE.Color(isDay ? 0x66ccff : 0x050520);
                this.scene.fog = new THREE.FogExp2(isDay ? 0x99ccff : 0x0a0a2a, 0.0001);
                this.scene.add(new THREE.AmbientLight(0xffffff, isDay ? 1.0 : 0.6));
                const sun = new THREE.DirectionalLight(0xffffff, 1.3);
                sun.position.set(2000, 3000, -2000);
                this.scene.add(sun);
                const ocean = new THREE.Mesh(new THREE.PlaneGeometry(80000, 80000), new THREE.MeshStandardMaterial({ color: 0x003366, metalness: 0.6, roughness: 0.2 }));
                ocean.rotation.x = -Math.PI/2;
                this.scene.add(ocean);

                this.createLandmarks();
                for(let i=0; i<15; i++) {
                    const ship = this.createShip();
                    ship.position.set((Math.random()-0.5)*40000, 0, (Math.random()-0.5)*40000);
                    this.scene.add(ship);
                    this.entities.ships.push({ mesh: ship, speed: 0.2 + Math.random()*0.3 });
                }
                for(let i=0; i<6; i++) {
                    const plane = this.createAirliner();
                    plane.position.set((Math.random()-0.5)*60000, 3500 + Math.random()*2500, (Math.random()-0.5)*60000);
                    this.scene.add(plane);
                    this.entities.airliners.push({ mesh: plane, speed: 2.5 + Math.random()*1.5, trailTimer: 0 });
                }

                this.runway = new THREE.Group();
                const deck = new THREE.Mesh(new THREE.BoxGeometry(300, 15, 2500), new THREE.MeshStandardMaterial({color:0x222222}));
                const strip = new THREE.Mesh(new THREE.PlaneGeometry(15, 2500), new THREE.MeshBasicMaterial({color:0xbbbb00}));
                strip.rotation.x = -Math.PI/2; strip.position.y = 7.6;
                this.runway.add(deck, strip);
                this.scene.add(this.runway);
            }

            createLandmarks() {
                const eiffel = new THREE.Group();
                eiffel.add(new THREE.Mesh(new THREE.BoxGeometry(100, 20, 100), new THREE.MeshStandardMaterial({color:0x555555})));
                const b2 = new THREE.Mesh(new THREE.ConeGeometry(40, 400, 4), new THREE.MeshStandardMaterial({color:0x666666}));
                b2.position.y = 210; eiffel.add(b2);
                eiffel.position.set(5000, 0, -5000);
                this.scene.add(eiffel);
                this.entities.landmarks.push({mesh: eiffel, name: 'EIFFEL'});

                const sol = new THREE.Group();
                sol.add(new THREE.Mesh(new THREE.BoxGeometry(80, 80, 80), new THREE.MeshStandardMaterial({color:0x888888})));
                const body = new THREE.Mesh(new THREE.CylinderGeometry(20, 30, 150, 8), new THREE.MeshStandardMaterial({color:0x66aa99}));
                body.position.y = 115; sol.add(body);
                sol.position.set(-10000, 0, 5000);
                this.scene.add(sol);
                this.entities.landmarks.push({mesh: sol, name: 'LIBERTY'});
            }

            createShip() {
                const group = new THREE.Group();
                group.add(new THREE.Mesh(new THREE.BoxGeometry(60, 25, 200), new THREE.MeshStandardMaterial({color:0x444444})));
                const tower = new THREE.Mesh(new THREE.BoxGeometry(35, 40, 50), new THREE.MeshStandardMaterial({color:0x555555}));
                tower.position.set(0, 30, -30); group.add(tower);
                return group;
            }

            createAirliner() {
                const group = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({color:0xffffff, emissive: 0x111111});
                const body = new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 150, 12), mat);
                body.rotation.x = Math.PI/2;
                const wings = new THREE.Mesh(new THREE.BoxGeometry(140, 1.5, 40), mat);
                wings.position.z = 10; group.add(body, wings);
                return group;
            }

            createPlayer() {
                this.player = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.9, roughness: 0.1 });
                if(this.state.unit === 'JET') {
                    const body = new THREE.Mesh(new THREE.ConeGeometry(0.7, 7, 12), mat);
                    body.rotation.x = -Math.PI/2;
                    const wings = new THREE.Mesh(new THREE.BoxGeometry(6.5, 0.1, 2.5), mat);
                    wings.position.z = 0.5; this.player.add(body, wings);
                } else {
                    const core = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 3.5, 1, 24), mat);
                    const dome = new THREE.Mesh(new THREE.SphereGeometry(1.2, 24, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color:0x00f2ff, transparent:true, opacity:0.7}));
                    dome.position.y = 0.5; this.player.add(core, dome);
                }
                this.scene.add(this.player);
                this.player.position.set(0, 15, 1000);
                this.speed = 0;
            }

            spawnUnit(isAlly) {
                const unit = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({ color: isAlly ? 0x00aa44 : 0x440000 });
                unit.add(new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.6, 6), mat));
                unit.add(new THREE.Mesh(new THREE.BoxGeometry(8, 0.1, 2.5), mat));
                const x = (Math.random()-0.5)*15000; const z = (Math.random()-0.5)*15000;
                unit.position.set(x, 500+Math.random()*1500, z);
                this.scene.add(unit);
                const data = { mesh: unit, isAlly, hp: 3, offset: new THREE.Vector3((Math.random()-0.5)*120, (Math.random()-0.5)*60, 60 + Math.random()*60) };
                if(isAlly) this.entities.allies.push(data); else this.entities.enemies.push(data);
            }

            setupUI() {
                const bnd = (id, key) => document.getElementById(id).querySelectorAll('.opt-btn').forEach(b => b.onclick = () => {
                    document.getElementById(id).querySelector('.active').classList.remove('active');
                    b.classList.add('active'); this.state[key] = b.dataset.val;
                });
                bnd('unit-select', 'unit'); bnd('diff-select', 'difficulty');
                document.getElementById('start-btn').onclick = () => this.start();
                document.getElementById('speed-slider').oninput = (e) => {
                    this.input.thrust = e.target.value / 100;
                    if(this.audio.engine) {
                        if(!this.audio.engine.isPlaying) this.audio.engine.play();
                        this.audio.engine.setPlaybackRate(0.6 + this.input.thrust);
                    }
                };
                
                // Small Static Joystick Fixed
                nipplejs.create({ 
                    zone: document.getElementById('joystick-zone'), 
                    mode: 'static', 
                    position: {left: '50px', top: '50px'}, // Half of container width/height
                    color: 'cyan',
                    size: 60 // 50% smaller
                }).on('move', (e, d) => {
                    this.input.joystick.x = d.vector.x;
                    this.input.joystick.y = d.vector.y; 
                }).on('end', () => this.input.joystick = {x:0, y:0});

                document.getElementById('fire-btn').ontouchstart = (e) => { e.preventDefault(); this.input.firing = true; };
                document.getElementById('fire-btn').ontouchend = () => this.input.firing = false;
            }

            start() {
                this.state.difficulty = parseInt(this.state.difficulty);
                this.state.targetKills = 10 * this.state.difficulty;
                this.initAudio(); this.initWorld(); this.createPlayer();
                this.state.active = true; this.state.takeoff = true;
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                document.getElementById('msg-box').innerText = "FULL THRUST TO TAKEOFF!";
                for(let i=0; i<this.state.targetKills; i++) this.spawnUnit(false);
                for(let i=0; i<2; i++) this.spawnUnit(true);
                this.timerInterval = setInterval(() => {
                    if(this.state.active && !this.state.paused) {
                        this.state.timeLeft--;
                        if(this.state.timeLeft <= 0) this.gameOver(false);
                    }
                }, 1000);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                if (!this.state.active || this.state.paused) {
                    this.renderer.render(this.scene, this.camera);
                    return;
                }
                const delta = Math.min(this.clock.getDelta(), 0.1);

                if(this.state.takeoff) {
                    this.speed = THREE.MathUtils.lerp(this.speed, this.input.thrust * 4.5, 0.03);
                    this.player.translateZ(-this.speed);
                    if(this.speed > 2.0 && this.player.position.z < 200) {
                        this.player.rotateX(0.4 * delta);
                        if(this.player.position.y > 150) {
                            this.state.takeoff = false;
                            document.getElementById('msg-box').innerText = "";
                        }
                    }
                } else {
                    // Control: Move UP -> Climb, Move DOWN -> Dive
                    const pitch = this.input.joystick.y; 
                    const roll = -this.input.joystick.x;
                    
                    if(Math.abs(pitch) > 0.05 || Math.abs(roll) > 0.05) {
                        this.player.rotateX(pitch * 2.5 * delta);
                        this.player.rotateZ(roll * 3.5 * delta);
                        this.player.rotateY(-roll * 1.5 * delta);
                    } else {
                        const targetQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, this.player.rotation.y, 0));
                        this.player.quaternion.slerp(targetQuat, 0.04);
                    }
                    this.speed = THREE.MathUtils.lerp(this.speed, this.input.thrust * (6.0 + this.state.difficulty), 0.05);
                    this.player.translateZ(-this.speed);
                }

                this.entities.allies.forEach(al => {
                    const targetPos = this.player.position.clone().add(al.offset.clone().applyQuaternion(this.player.quaternion));
                    al.mesh.position.lerp(targetPos, 0.08); al.mesh.quaternion.slerp(this.player.quaternion, 0.08);
                });

                this.entities.ships.forEach(s => { s.mesh.translateZ(s.speed); if(s.mesh.position.z > 40000) s.mesh.position.z = -40000; });
                this.entities.airliners.forEach(a => { 
                    a.mesh.translateZ(a.speed); if(a.mesh.position.z > 40000) a.mesh.position.z = -40000; 
                    a.trailTimer += delta; if(a.trailTimer > 0.15) { this.createTrail(a.mesh.position.clone().add(new THREE.Vector3(0,0,10))); a.trailTimer = 0; }
                });

                if(this.input.firing && this.clock.elapsedTime % 0.15 < 0.02) {
                    if(this.audio.laser) { if(this.audio.laser.isPlaying) this.audio.laser.stop(); this.audio.laser.play(); }
                    const b = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 6), new THREE.MeshBasicMaterial({color:0x00f2ff}));
                    b.position.copy(this.player.position); b.quaternion.copy(this.player.quaternion);
                    this.scene.add(b);
                    this.entities.bullets.push({ mesh: b, life: 1.8, vel: new THREE.Vector3(0,0,-50).applyQuaternion(this.player.quaternion) });
                }

                for(let i=this.entities.bullets.length-1; i>=0; i--) {
                    const b = this.entities.bullets[i]; b.mesh.position.add(b.vel); b.life -= delta;
                    this.entities.enemies.forEach((en, ei) => {
                        if(b.mesh.position.distanceTo(en.mesh.position) < 60) {
                            if(this.audio.explosion) { if(this.audio.explosion.isPlaying) this.audio.explosion.stop(); this.audio.explosion.play(); }
                            this.createExplosion(en.mesh.position);
                            this.scene.remove(en.mesh); this.entities.enemies.splice(ei, 1);
                            b.life = 0; this.state.kills++;
                            if(this.state.kills >= this.state.targetKills) this.gameOver(true);
                        }
                    });
                    if(b.life <= 0) { this.scene.remove(b.mesh); this.entities.bullets.splice(i, 1); }
                }

                // Radar Update
                const dots = document.getElementById('radar-dots'); dots.innerHTML = '';
                [...this.entities.enemies, ...this.entities.allies, ...this.entities.landmarks].forEach(ent => {
                    const dx = ent.mesh.position.x - this.player.position.x;
                    const dz = ent.mesh.position.z - this.player.position.z;
                    if(dx*dx + dz*dz < 10000*10000) {
                        const dot = document.createElement('div'); dot.className = 'radar-dot';
                        dot.style.left = (dx / 10000) * 45 + 45 + 'px'; dot.style.top = (dz / 10000) * 45 + 45 + 'px';
                        dot.style.backgroundColor = ent.isAlly ? 'var(--ally)' : (ent.name ? 'white' : 'var(--danger)');
                        dots.appendChild(dot);
                    }
                });

                if(Math.abs(this.player.position.x) > 40000) this.player.position.x *= -0.99;
                if(Math.abs(this.player.position.z) > 40000) this.player.position.z *= -0.99;

                const camOff = new THREE.Vector3(0, 3.8, 13 + this.speed*2.5).applyQuaternion(this.player.quaternion);
                this.camera.position.lerp(this.player.position.clone().add(camOff), 0.15);
                this.camera.lookAt(this.player.position.clone().add(new THREE.Vector3(0,0,-25).applyQuaternion(this.player.quaternion)));

                if(!this.state.takeoff && this.player.position.y < 5) this.gameOver(false);

                document.getElementById('alt-val').innerText = Math.floor(this.player.position.y);
                document.getElementById('spd-val').innerText = (this.speed * 180).toFixed(0);
                document.getElementById('kill-val').innerText = this.state.kills;
                document.getElementById('target-val').innerText = this.state.targetKills;
                document.getElementById('timer-val').innerText = this.state.timeLeft;
                this.renderer.render(this.scene, this.camera);
            }

            createExplosion(pos) {
                const count = 30;
                for(let i=0; i<count; i++) {
                    const isSmoke = Math.random() > 0.4;
                    const p = new THREE.Mesh(new THREE.SphereGeometry(isSmoke ? 4 : 2, 8, 8), new THREE.MeshBasicMaterial({ color: isSmoke ? 0x666666 : 0xffaa00, transparent: true, opacity: 1.0 }));
                    p.position.copy(pos); this.scene.add(p);
                    this.entities.particles.push({ mesh: p, vel: new THREE.Vector3((Math.random()-0.5)*12, (Math.random()-0.5)*12, (Math.random()-0.5)*12), life: isSmoke ? 2.5 : 1.2, isSmoke });
                }
            }

            createTrail(pos) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(3, 4, 4), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.4 }));
                p.position.copy(pos); this.scene.add(p);
                this.entities.particles.push({ mesh: p, vel: new THREE.Vector3(0,0,0), life: 2.0 });
            }

            gameOver(success) {
                this.state.active = false; clearInterval(this.timerInterval);
                document.getElementById('over-title').innerText = success ? "MISSION COMPLETE" : "MISSION FAILED";
                document.getElementById('over-stats').innerText = `ACE LEVEL ${this.state.difficulty} | KILLS: ${this.state.kills}`;
                document.getElementById('over-screen').style.display = 'flex';
                if(this.audio.engine) this.audio.engine.stop();
            }
        }
        window.onload = () => new Game();
    </script>
</body>
</html>